'use client'

import { useState, useEffect } from 'react'
import { Target, Sparkles, AlertCircle, CheckCircle, Loader, Plus, X } from 'lucide-react'
import { api } from '@/lib/api'

interface ContextSetupStepProps {
  parsedData: any
  onComplete: () => void
  onNext: () => void
}

interface Suggestions {
  suggested_roles: string[]
  suggested_industries: string[]
  suggested_keywords: string[]
  suggested_geography: string[]
}

export default function ContextSetupStep({ parsedData, onComplete, onNext }: ContextSetupStepProps) {
  const [formData, setFormData] = useState({
    targetRoles: [] as string[],
    preferredIndustries: [] as string[],
    pitchTone: 'professional',
    keywords: [] as string[],
    customMessage: '',
    geography: [] as string[],
  })

  const [suggestions, setSuggestions] = useState<Suggestions | null>(null)
  const [loadingSuggestions, setLoadingSuggestions] = useState(false)
  const [loading, setLoading] = useState(false)
  const [success, setSuccess] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const [inputValues, setInputValues] = useState({
    role: '',
    industry: '',
    keyword: '',
    location: ''
  })

  // Load suggestions on mount
  useEffect(() => {
    loadSuggestions()
  }, [])

  const loadSuggestions = async () => {
    setLoadingSuggestions(true)
    try {
      const response = await api.getContextSuggestions()
      setSuggestions(response.data)
    } catch (err: any) {
      console.error('Failed to load suggestions:', err)
    } finally {
      setLoadingSuggestions(false)
    }
  }

  const addItem = (field: 'targetRoles' | 'preferredIndustries' | 'keywords' | 'geography', value: string) => {
    if (value.trim() && !formData[field].includes(value.trim())) {
      setFormData({
        ...formData,
        [field]: [...formData[field], value.trim()]
      })
    }
  }

  const removeItem = (field: 'targetRoles' | 'preferredIndustries' | 'keywords' | 'geography', index: number) => {
    setFormData({
      ...formData,
      [field]: formData[field].filter((_, i) => i !== index)
    })
  }

  const addFromSuggestion = (field: 'targetRoles' | 'preferredIndustries' | 'keywords' | 'geography', value: string) => {
    addItem(field, value)
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)
    setSuccess(false)

    try {
      const payload = {
        target_roles: formData.targetRoles,
        preferred_industries: formData.preferredIndustries,
        pitch_tone: formData.pitchTone,
        keywords: formData.keywords,
        custom_message: formData.customMessage,
        geography: formData.geography,
      }

      await api.buildContext(payload)
      setSuccess(true)
      onComplete()
      
      // Don't auto-advance, let user click button
    } catch (err: any) {
      setError(err.response?.data?.detail || 'Failed to save context')
    } finally {
      setLoading(false)
    }
  }

  const TagInput = ({ 
    label, 
    field, 
    placeholder, 
    suggestionsKey, 
    inputKey 
  }: { 
    label: string
    field: 'targetRoles' | 'preferredIndustries' | 'keywords' | 'geography'
    placeholder: string
    suggestionsKey: keyof Suggestions
    inputKey: keyof typeof inputValues
  }) => (
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-2">
        {label}
      </label>
      
      {/* Input */}
      <div className="flex gap-2 mb-3">
        <input
          type="text"
          value={inputValues[inputKey]}
          onChange={(e) => setInputValues({ ...inputValues, [inputKey]: e.target.value })}
          onKeyPress={(e) => {
            if (e.key === 'Enter') {
              e.preventDefault()
              addItem(field, inputValues[inputKey])
              setInputValues({ ...inputValues, [inputKey]: '' })
            }
          }}
          placeholder={placeholder}
          className="input-field flex-1"
        />
        <button
          type="button"
          onClick={() => {
            addItem(field, inputValues[inputKey])
            setInputValues({ ...inputValues, [inputKey]: '' })
          }}
          className="btn-secondary"
        >
          <Plus className="w-4 h-4" />
        </button>
      </div>

      {/* Selected Tags */}
      {formData[field].length > 0 && (
        <div className="flex flex-wrap gap-2 mb-3">
          {formData[field].map((item, idx) => (
            <span key={idx} className="inline-flex items-center gap-1 px-3 py-1 bg-primary-100 text-primary-700 text-sm rounded-full">
              {item}
              <button
                type="button"
                onClick={() => removeItem(field, idx)}
                className="hover:text-primary-900"
              >
                <X className="w-3 h-3" />
              </button>
            </span>
          ))}
        </div>
      )}

      {/* AI Suggestions */}
      {loadingSuggestions ? (
        <div className="flex items-center gap-2 text-sm text-gray-500 mb-2">
          <Loader className="w-4 h-4 animate-spin" />
          <span>Loading AI suggestions...</span>
        </div>
      ) : suggestions && suggestions[suggestionsKey].length > 0 && (
        <div className="mb-2">
          <p className="text-xs text-gray-500 mb-2 flex items-center gap-1">
            <Sparkles className="w-3 h-3" />
            AI Suggestions (click to add):
          </p>
          <div className="flex flex-wrap gap-2">
            {suggestions[suggestionsKey]
              .filter(item => !formData[field].includes(item))
              .map((item, idx) => (
                <button
                  key={idx}
                  type="button"
                  onClick={() => addFromSuggestion(field, item)}
                  className="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded border border-purple-200 hover:bg-purple-100 transition-colors"
                >
                  + {item}
                </button>
              ))}
          </div>
        </div>
      )}
    </div>
  )

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-gray-900 mb-2">Setup Your Context</h2>
      <p className="text-gray-600 mb-6">
        Define your job search preferences. AI has suggested options based on your resume.
      </p>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Target Roles */}
        <TagInput
          label="Target Roles"
          field="targetRoles"
          placeholder="e.g., Software Engineer"
          suggestionsKey="suggested_roles"
          inputKey="role"
        />

        {/* Preferred Industries */}
        <TagInput
          label="Preferred Industries"
          field="preferredIndustries"
          placeholder="e.g., Technology, Finance"
          suggestionsKey="suggested_industries"
          inputKey="industry"
        />

        {/* Keywords */}
        <TagInput
          label="Keywords & Skills"
          field="keywords"
          placeholder="e.g., React, Python, Leadership"
          suggestionsKey="suggested_keywords"
          inputKey="keyword"
        />

        {/* Geography */}
        <TagInput
          label="Preferred Locations"
          field="geography"
          placeholder="e.g., Remote, San Francisco, New York"
          suggestionsKey="suggested_geography"
          inputKey="location"
        />

        {/* Pitch Tone */}
        <div>
          <label htmlFor="pitchTone" className="block text-sm font-medium text-gray-700 mb-2">
            Email Tone
          </label>
          <select
            id="pitchTone"
            name="pitchTone"
            value={formData.pitchTone}
            onChange={(e) => setFormData({ ...formData, pitchTone: e.target.value })}
            className="input-field"
          >
            <option value="professional">Professional</option>
            <option value="friendly">Friendly</option>
            <option value="casual">Casual</option>
            <option value="formal">Formal</option>
          </select>
        </div>

        {/* Custom Message */}
        <div>
          <label htmlFor="customMessage" className="block text-sm font-medium text-gray-700 mb-2">
            Custom Message (Optional)
          </label>
          <textarea
            id="customMessage"
            name="customMessage"
            value={formData.customMessage}
            onChange={(e) => setFormData({ ...formData, customMessage: e.target.value })}
            placeholder="Any specific message or requirements you want to include in outreach emails..."
            rows={3}
            className="input-field"
          />
        </div>

        {/* Error Message */}
        {error && (
          <div className="p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
            <p className="text-sm text-red-700">{error}</p>
          </div>
        )}

        {/* Success Message */}
        {success && (
          <div className="p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3">
            <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
            <p className="text-sm text-green-700">Context saved successfully! Moving to next step...</p>
          </div>
        )}

        {/* Submit Button */}
        <button
          type="submit"
          disabled={loading || success || formData.targetRoles.length === 0}
          className="btn-primary w-full"
        >
          {loading ? (
            <span className="flex items-center justify-center gap-2">
              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
              Saving Context...
            </span>
          ) : (
            'Save Context'
          )}
        </button>

        {/* Continue Button (after success) */}
        {success && (
          <button
            type="button"
            onClick={onNext}
            className="btn-primary w-full mt-3"
          >
            Continue to Email Integration â†’
          </button>
        )}
      </form>
    </div>
  )
}
